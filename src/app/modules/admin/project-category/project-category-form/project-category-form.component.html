<div class="row">
    <!-- Cấu hình Category -->
    <div class="col-md-7">
        <nb-card>
            <nb-card-header>{{ isEdit ? 'Sửa' : 'Tạo mới' }} danh mục dự án ({{ typeLabel }})</nb-card-header>
            <nb-card-body>
                <form [formGroup]="categoryForm">
                    <div class="form-group">
                        <label class="label">Tên Category</label>
                        <input nbInput fullWidth placeholder="Căn hộ, Nhà phố..." formControlName="name">
                    </div>
                    <div class="form-group">
                        <label class="label">Mô tả</label>
                        <textarea nbInput fullWidth placeholder="Mô tả ngắn về loại dự án này"
                            formControlName="description"></textarea>
                    </div>

                    <hr>
                    <div class="header-container mt-3 mb-2">
                        <label class="label">Định nghĩa các trường dữ liệu (Dynamic Fields)</label>
                        <button nbButton size="tiny" status="success" (click)="addField()">
                            <nb-icon icon="plus-outline"></nb-icon> Thêm trường
                        </button>
                    </div>

                    <div formArrayName="schema">
                        <div *ngFor="let field of schemaFormArray.controls; let i=index" [formGroupName]="i"
                            class="field-row mb-3">
                            <!-- Row 1: Label, Type, Required, Delete -->
                            <div class="row align-items-end mb-2">
                                <div class="col-md-4">
                                    <label class="label-small">Tên Field <span class="text-danger">*</span></label>
                                    <input nbInput fullWidth size="small" placeholder="Ví dụ: Lộ giới"
                                        formControlName="label">
                                </div>
                                <div class="col-md-3">
                                    <label class="label-small">Kiểu dữ liệu</label>
                                    <nb-select fullWidth size="small" formControlName="type">
                                        <nb-option *ngFor="let type of fieldTypes" [value]="type.value">{{ type.label
                                            }}</nb-option>
                                    </nb-select>
                                </div>
                                <div class="col-md-2 text-center">
                                    <label class="label-small d-block">Bắt buộc</label>
                                    <nb-toggle size="tiny" formControlName="required"></nb-toggle>
                                </div>
                                <div class="col-md-3">
                                    <label class="label-small">Placeholder</label>
                                    <input nbInput fullWidth size="small" placeholder="Nhập gợi ý..."
                                        formControlName="placeholder">
                                </div>
                            </div>
                            <!-- Row 2: Description -->
                            <div class="row mb-2">
                                <div class="col-md-11">
                                    <label class="label-small">Mô tả (hiển thị dưới label)</label>
                                    <input nbInput fullWidth size="small" placeholder="Mô tả chi tiết cho trường này..."
                                        formControlName="description">
                                </div>
                                <div class="col-md-1 d-flex align-items-end">
                                    <button nbButton ghost status="danger" size="small" (click)="removeField(i)">
                                        <nb-icon icon="close-outline"></nb-icon>
                                    </button>
                                </div>
                            </div>
                            <!-- Row 3: Options (chỉ hiện khi type = select) -->
                            <div class="row" *ngIf="field.get('type').value === 'select'">
                                <div class="col-md-12">
                                    <label class="label-small">Các lựa chọn (cách bởi dấu phẩy, mỗi option có thể có mô
                                        tả bằng dấu |)</label>
                                    <input nbInput fullWidth size="small"
                                        placeholder="Đông|Hướng đông, Tây|Hướng tây, Nam, Bắc"
                                        formControlName="options">
                                    <!-- <small class="text-hint">Ví dụ: "Đông|Mô tả 1, Tây|Mô tả 2" hoặc "A, B, C"</small> -->
                                </div>
                            </div>
                        </div>
                        <div *ngIf="schemaFormArray.length === 0" class="text-center p-3 text-hint">
                            Chưa có trường dữ liệu nào. Nhấn "Thêm trường" để bắt đầu.
                        </div>
                    </div>
                </form>
            </nb-card-body>
            <nb-card-footer>
                <button nbButton status="primary" (click)="save()">Lưu Category</button>
                <button nbButton ghost class="ml-2" [routerLink]="['/admin/project-category', type]">Hủy</button>
            </nb-card-footer>
        </nb-card>
    </div>

    <!-- Preview Giao diện -->
    <div class="col-md-5">
        <nb-card status="info">
            <nb-card-header>Xem trước (Preview) Form Dự án</nb-card-header>
            <nb-card-body>
                <div class="preview-container">
                    <h6>Thông tin chung (Mặc định)</h6>
                    <div class="form-group"><label class="label">Tên dự án</label><input nbInput fullWidth disabled
                            placeholder="Auto-generated"></div>

                    <h6 class="mt-3">Thông tin đặc thù ({{ categoryForm.get('name').value || 'Mới' }})</h6>
                    <div *ngFor="let field of schemaFormArray.value" class="form-group">
                        <label class="label">{{ field.label || '(Chưa đặt tên)' }} <span *ngIf="field.required"
                                class="text-danger">*</span></label>
                        <small *ngIf="field.description" class="d-block text-muted mb-1">{{ field.description }}</small>

                        <input *ngIf="field.type === 'text'" nbInput fullWidth
                            [placeholder]="field.placeholder || 'Nhập văn bản...'">
                        <input *ngIf="field.type === 'number'" type="number" nbInput fullWidth
                            [placeholder]="field.placeholder || 'Nhập số...'">
                        <input *ngIf="field.type === 'date'" type="date" nbInput fullWidth>
                        <nb-select *ngIf="field.type === 'select'" fullWidth
                            [placeholder]="field.placeholder || 'Chọn giá trị'">
                            <nb-option *ngFor="let op of (field.options?.split(',') || [])"
                                [value]="op.split('|')[0]?.trim()">
                                {{ op.split('|')[0]?.trim() }}
                                <span *ngIf="op.split('|')[1]" class="text-muted"> - {{ op.split('|')[1]?.trim()
                                    }}</span>
                            </nb-option>
                        </nb-select>
                        <textarea *ngIf="field.type === 'html'" nbInput fullWidth rows="4"
                            [placeholder]="field.placeholder || 'Nhập nội dung HTML...'"></textarea>
                        <small *ngIf="field.type === 'html'" class="text-hint">Trường này hỗ trợ định dạng HTML</small>

                        <!-- Images Upload Preview -->
                        <div *ngIf="field.type === 'images'" class="media-upload-zone">
                            <div class="upload-box">
                                <nb-icon icon="image-outline" class="upload-icon"></nb-icon>
                                <span>Kéo thả ảnh hoặc click để upload</span>
                                <small class="text-muted d-block">Hỗ trợ: JPG, PNG, GIF</small>
                            </div>
                            <div class="url-input mt-2">
                                <input nbInput fullWidth size="small" placeholder="Hoặc nhập URL ảnh...">
                                <button nbButton size="small" status="primary" class="mt-1">Thêm URL</button>
                            </div>
                        </div>

                        <!-- Video Upload Preview -->
                        <div *ngIf="field.type === 'video'" class="media-upload-zone">
                            <div class="upload-box video">
                                <nb-icon icon="video-outline" class="upload-icon"></nb-icon>
                                <span>Kéo thả video hoặc click để upload</span>
                                <small class="text-muted d-block">Hỗ trợ: MP4, WebM, YouTube URL</small>
                            </div>
                            <div class="url-input mt-2">
                                <input nbInput fullWidth size="small"
                                    placeholder="Hoặc nhập URL video (YouTube, Vimeo...)">
                                <button nbButton size="small" status="primary" class="mt-1">Thêm URL</button>
                            </div>
                        </div>
                    </div>
                    <div *ngIf="schemaFormArray.length === 0" class="text-center p-4 border-dashed">
                        Các trường bạn định nghĩa sẽ hiện ở đây
                    </div>
                </div>
            </nb-card-body>
        </nb-card>
    </div>
</div>

<style>
    .label-small {
        font-size: 0.75rem;
        color: #8f9bb3;
        margin-bottom: 0.25rem;
        font-weight: bold;
    }

    .field-row {
        padding: 10px;
        border: 1px solid #edf1f7;
        border-radius: 4px;
        background: #f7f9fc;
    }

    .header-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .border-dashed {
        border: 2px dashed #edf1f7;
        color: #8f9bb3;
        border-radius: 4px;
    }

    .ml-2 {
        margin-left: 0.5rem;
    }

    /* Media Upload Zone Styles */
    .media-upload-zone {
        border: 1px solid #edf1f7;
        border-radius: 4px;
        padding: 10px;
        background: #f7f9fc;
    }

    .upload-box {
        border: 2px dashed #3366ff;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        background: #f0f4ff;
        transition: all 0.2s ease;
    }

    .upload-box:hover {
        background: #e6edff;
        border-color: #274bdb;
    }

    .upload-box.video {
        border-color: #ff3d71;
        background: #fff0f4;
    }

    .upload-box.video:hover {
        background: #ffe0e9;
        border-color: #db2c66;
    }

    .upload-icon {
        font-size: 2rem;
        display: block;
        margin-bottom: 8px;
        color: #3366ff;
    }

    .upload-box.video .upload-icon {
        color: #ff3d71;
    }

    .url-input {
        padding-top: 10px;
        border-top: 1px dashed #edf1f7;
    }
</style>