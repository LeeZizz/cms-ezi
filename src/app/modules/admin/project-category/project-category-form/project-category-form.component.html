<nb-card>
    <nb-card-header>{{ isEdit ? 'Sửa' : 'Tạo mới' }} danh mục dự án ({{ typeLabel }})</nb-card-header>
    <nb-card-body>
        <form [formGroup]="categoryForm">
            <!-- Thông tin cơ bản -->
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="label">Tên Category <span class="text-danger">*</span></label>
                        <input nbInput fullWidth placeholder="Căn hộ, Nhà phố..." formControlName="name">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="label">Mô tả</label>
                        <input nbInput fullWidth placeholder="Mô tả ngắn về loại dự án này"
                            formControlName="description">
                    </div>
                </div>
            </div>

            <hr>

            <!-- Dynamic Fields Section -->
            <div class="fields-section">
                <div class="section-header">
                    <h6>Định nghĩa các trường dữ liệu (Dynamic Fields)</h6>
                    <div class="section-actions">
                        <div class="search-box">
                            <nb-icon icon="search-outline" class="search-icon"></nb-icon>
                            <input nbInput size="small" placeholder="Tìm thuộc tính..." [(ngModel)]="fieldSearchKeyword"
                                [ngModelOptions]="{standalone: true}" (input)="onFieldSearch()">
                            <button nbButton ghost size="small" class="clear-btn" *ngIf="fieldSearchKeyword"
                                (click)="clearFieldSearch()">
                                <nb-icon icon="close-outline"></nb-icon>
                            </button>
                        </div>
                        <button nbButton size="small" status="primary" (click)="addFieldAndExpand()">
                            <nb-icon icon="plus-outline"></nb-icon> Thêm mới
                        </button>
                    </div>
                </div>

                <!-- Bảng thuộc tính -->
                <table class="table table-bordered" *ngIf="schemaFormArray.length > 0">
                    <thead>
                        <tr>
                            <th class="col-stt">#</th>
                            <th class="col-code">Mã thuộc tính</th>
                            <th class="col-name">Tên thuộc tính</th>
                            <th class="col-default">Giá trị mặc định</th>
                            <th class="col-required">Bắt buộc</th>
                            <th class="col-type">Loại</th>
                            <th class="col-action">Thao tác</th>
                        </tr>
                    </thead>
                    <tbody formArrayName="schema">
                        <ng-container *ngFor="let field of pagedFields; let i = index">
                            <!-- Hàng chính -->
                            <tr [class.row-expanded]="expandedFieldIndex === i" (click)="toggleFieldExpand(i)"
                                class="field-row">
                                <td>{{ i + 1 }}</td>
                                <td>{{ field.get('code')?.value || '(chưa có)' }}</td>
                                <td>{{ field.get('label')?.value || '(chưa đặt tên)' }}</td>
                                <td>{{ field.get('defaultValue')?.value || '...' }}</td>
                                <td>
                                    <span *ngIf="field.get('required')?.value" class="badge-required">Bắt buộc</span>
                                </td>
                                <td>{{ getFieldTypeLabel(field.get('type')?.value) }}</td>
                                <td class="action-cell" (click)="$event.stopPropagation()">
                                    <button nbButton ghost status="info" size="small" (click)="toggleFieldExpand(i)"
                                        title="Chỉnh sửa">
                                        <nb-icon icon="edit-outline"></nb-icon>
                                    </button>
                                    <button nbButton ghost status="danger" size="small" (click)="removeField(i)"
                                        title="Xóa">
                                        <nb-icon icon="trash-2-outline"></nb-icon>
                                    </button>
                                </td>
                            </tr>

                            <!-- Panel mở rộng (Expandable Row) -->
                            <tr *ngIf="expandedFieldIndex === i" class="expanded-panel-row">
                                <td colspan="7">
                                    <div class="expanded-panel" [formGroupName]="getActualIndex(i)">
                                        <div class="panel-header">
                                            <span>{{ field.get('label')?.value || 'Thuộc tính mới' }}</span>
                                            <button nbButton ghost size="tiny" (click)="toggleFieldExpand(i)">
                                                <nb-icon icon="close-outline"></nb-icon>
                                            </button>
                                        </div>
                                        <div class="panel-body">
                                            <!-- Row 1: Code, Label -->
                                            <div class="row mb-2">
                                                <div class="col-md-4">
                                                    <label class="label-small">Mã thuộc tính</label>
                                                    <input nbInput fullWidth size="small" placeholder="vd: dientich"
                                                        formControlName="code">
                                                </div>
                                                <div class="col-md-4">
                                                    <label class="label-small">Tên thuộc tính <span
                                                            class="text-danger">*</span></label>
                                                    <input nbInput fullWidth size="small"
                                                        placeholder="vd: Diện tích (m²)" formControlName="label">
                                                </div>
                                                <div class="col-md-2">
                                                    <label class="label-small">Kiểu dữ liệu</label>
                                                    <nb-select fullWidth size="small" formControlName="type">
                                                        <nb-option *ngFor="let type of fieldTypes" [value]="type.value">
                                                            {{ type.label }}
                                                        </nb-option>
                                                    </nb-select>
                                                </div>
                                                <div class="col-md-2 text-center">
                                                    <label class="label-small d-block">Bắt buộc</label>
                                                    <nb-toggle size="tiny" formControlName="required"></nb-toggle>
                                                </div>
                                            </div>
                                            <!-- Row 2: Giá trị mặc định, Description -->
                                            <div class="row mb-2">
                                                <div class="col-md-4">
                                                    <label class="label-small">Giá trị mặc định</label>
                                                    <input nbInput fullWidth size="small"
                                                        placeholder="Giá trị mặc định..."
                                                        formControlName="defaultValue">
                                                </div>
                                                <div class="col-md-8">
                                                    <label class="label-small">Mô tả</label>
                                                    <input nbInput fullWidth size="small"
                                                        placeholder="Mô tả chi tiết cho trường này..."
                                                        formControlName="description">
                                                </div>
                                            </div>
                                            <!-- Row 3: Options (chỉ hiện khi type = select) -->
                                            <div class="row" *ngIf="field.get('type')?.value === 'select'">
                                                <div class="col-md-12">
                                                    <label class="label-small">Các lựa chọn (cách bởi dấu phẩy)</label>
                                                    <input nbInput fullWidth size="small"
                                                        placeholder="Đông, Tây, Nam, Bắc" formControlName="options">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        </ng-container>
                    </tbody>
                </table>

                <!-- Pagination -->
                <div class="pagination-container" *ngIf="filteredFields.length > pageSize">
                    <div class="pagination-info">
                        Hiển thị {{ (currentPage - 1) * pageSize + 1 }} - {{ Math.min(currentPage * pageSize,
                        filteredFields.length) }} / {{ filteredFields.length }} thuộc tính
                    </div>
                    <div class="pagination-controls">
                        <button nbButton ghost size="small" [disabled]="currentPage === 1" (click)="goToPage(1)">
                            <nb-icon icon="arrowhead-left-outline"></nb-icon>
                        </button>
                        <button nbButton ghost size="small" [disabled]="currentPage === 1"
                            (click)="goToPage(currentPage - 1)">
                            <nb-icon icon="arrow-back-outline"></nb-icon>
                        </button>
                        <span class="page-number">Trang {{ currentPage }} / {{ totalPages }}</span>
                        <button nbButton ghost size="small" [disabled]="currentPage === totalPages"
                            (click)="goToPage(currentPage + 1)">
                            <nb-icon icon="arrow-forward-outline"></nb-icon>
                        </button>
                        <button nbButton ghost size="small" [disabled]="currentPage === totalPages"
                            (click)="goToPage(totalPages)">
                            <nb-icon icon="arrowhead-right-outline"></nb-icon>
                        </button>
                    </div>
                </div>

                <!-- Empty state -->
                <div *ngIf="schemaFormArray.length === 0" class="empty-state">
                    <nb-icon icon="file-add-outline"></nb-icon>
                    <p>Chưa có thuộc tính nào. Nhấn "Thêm mới" để bắt đầu.</p>
                </div>
            </div>
        </form>
    </nb-card-body>
    <nb-card-footer>
        <button nbButton status="primary" (click)="save()">
            <nb-icon icon="save-outline"></nb-icon> Lưu Category
        </button>
        <button nbButton ghost class="ml-2" [routerLink]="['/admin/project-category', type]">Hủy</button>
    </nb-card-footer>
</nb-card>